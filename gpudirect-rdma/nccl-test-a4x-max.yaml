apiVersion: v1
kind: Service
metadata:
  name: nccl-host-1
spec:
  selector:
    name: nccl-host-1
  clusterIP: None
---
apiVersion: v1
kind: Service
metadata:
  name: nccl-host-2
spec:
  selector:
    name: nccl-host-2
  clusterIP: None
---
apiVersion: resource.nvidia.com/v1beta1
kind: ComputeDomain
metadata:
  name: nccl-test-compute-domain
spec:
  numNodes: 2
  channel:
    resourceClaimTemplate:
      name: nccl-test-compute-domain-channel
---
apiVersion: resource.k8s.io/v1
kind: ResourceClaimTemplate
metadata:
  name: nccl-test-all-mrdma
spec:
  spec:
    devices:
      requests:
      - name: req-mrdma
        exactly:
          deviceClassName: mrdma.google.com
          allocationMode: ExactCount
          count: 8
---
apiVersion: v1
kind: Pod
metadata:
  name: nccl-test-host-1
  labels:
    name: nccl-host-1
spec:
  tolerations:
  - key: "kubernetes.io/arch"
    operator: "Equal"
    value: "arm64"
    effect: "NoSchedule"
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: cloud.google.com/gke-accelerator
            operator: In
            values:
            - nvidia-gb300
          - key: kubernetes.io/arch
            operator: In
            values:
            - arm64
  hostPID: false
  volumes:
  - name: library-dir-host
    hostPath:
      path: /home/kubernetes/bin/nvidia
  - name: shared-memory
    emptyDir:
      medium: "Memory"
      sizeLimit: 250Gi
  containers:
  - image: us-docker.pkg.dev/gce-ai-infra/gpudirect-gib/nccl-gib-a4x-max-arm64@sha256:a0a914c56b8eeb8130ed4d8a5fb811d87826964b4458cbd87740a33bd1e66d33
    securityContext:
      capabilities:
        add: ["IPC_LOCK"]
    name: test
    resources:
      requests:
        cpu: 150m
    volumeMounts:
    - name: library-dir-host
      mountPath: /usr/local/nvidia
    - name: shared-memory
      mountPath: /dev/shm
    env:
    - name: LD_LIBRARY_PATH
      value: /usr/local/nvidia/lib64
    resources:
      limits:
        nvidia.com/gpu: 4
      claims:
        - name: compute-domain-channel
        - name: rdma
    command: ["/bin/bash", "-c"]
    args:
    - |
      /scripts/container_entry.sh shell
      sleep infinity
  resourceClaims:
  - name: compute-domain-channel
    resourceClaimTemplateName: nccl-test-compute-domain-channel
  - name: rdma
    resourceClaimTemplateName: nccl-test-all-mrdma
---
apiVersion: v1
kind: Pod
metadata:
  name: nccl-test-host-2
  labels:
    name: nccl-host-2
spec:
  tolerations:
  - key: "kubernetes.io/arch"
    operator: "Equal"
    value: "arm64"
    effect: "NoSchedule"
  affinity:
    nodeAffinity:
      requiredDuringSchedulingIgnoredDuringExecution:
        nodeSelectorTerms:
        - matchExpressions:
          - key: cloud.google.com/gke-accelerator
            operator: In
            values:
            - nvidia-gb300
          - key: kubernetes.io/arch
            operator: In
            values:
            - arm64
  hostPID: false
  volumes:
  - name: library-dir-host
    hostPath:
      path: /home/kubernetes/bin/nvidia
  - name: shared-memory
    emptyDir:
      medium: "Memory"
      sizeLimit: 250Gi
  containers:
  - image: us-docker.pkg.dev/gce-ai-infra/gpudirect-gib/nccl-gib-a4x-max-arm64@sha256:a0a914c56b8eeb8130ed4d8a5fb811d87826964b4458cbd87740a33bd1e66d33
    securityContext:
      capabilities:
        add: ["IPC_LOCK"]
    name: test
    resources:
      requests:
        cpu: 150m
    volumeMounts:
    - name: library-dir-host
      mountPath: /usr/local/nvidia
    - name: shared-memory
      mountPath: /dev/shm
    env:
    - name: LD_LIBRARY_PATH
      value: /usr/local/nvidia/lib64
    resources:
      limits:
        nvidia.com/gpu: 4
      claims:
        - name: compute-domain-channel
        - name: rdma
    command: ["/bin/bash", "-c"]
    args:
    - |
      /scripts/container_entry.sh shell
      sleep infinity
  resourceClaims:
  - name: compute-domain-channel
    resourceClaimTemplateName: nccl-test-compute-domain-channel
  - name: rdma
    resourceClaimTemplateName: nccl-test-all-mrdma